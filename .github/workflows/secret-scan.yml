name: Secret and Sensitive Data Scan

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  gitleaks-scan:
    name: Gitleaks Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  trufflehog-scan:
    name: TruffleHog Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --results=verified,unknown

  detect-secrets-scan:
    name: Detect Secrets Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install detect-secrets
        run: pip install detect-secrets

      - name: Run detect-secrets scan
        run: |
          # Exclude .git directory and test directories (test mocks contain fake SHAs/tokens)
          detect-secrets scan --all-files --force-use-all-plugins \
            --exclude-files '^\.git/' \
            --exclude-files '^Tests/' \
            > .secrets.baseline.json

          # Check if any secrets were found
          SECRETS_COUNT=$(cat .secrets.baseline.json | python3 -c "import sys, json; data = json.load(sys.stdin); print(sum(len(v) for v in data.get('results', {}).values()))")

          if [ "$SECRETS_COUNT" -gt 0 ]; then
            echo "::error::Found $SECRETS_COUNT potential secrets!"
            cat .secrets.baseline.json | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          for file, secrets in data.get('results', {}).items():
              for secret in secrets:
                  print(f\"  - {file}:{secret.get('line_number', 'unknown')}: {secret.get('type', 'unknown type')}\")
          "
            exit 1
          fi
          echo "No secrets detected by detect-secrets"

  sensitive-data-scan:
    name: Sensitive Data and PII Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Scan for hardcoded sensitive patterns
        run: |
          echo "Scanning for sensitive patterns..."
          FOUND_ISSUES=0

          # Patterns to search for (excluding common false positives)
          declare -A PATTERNS
          PATTERNS["API Keys"]='(?i)(api[_-]?key|apikey)\s*[:=]\s*["\x27]?[a-zA-Z0-9_\-]{20,}["\x27]?'
          PATTERNS["AWS Access Keys"]='AKIA[0-9A-Z]{16}'
          PATTERNS["AWS Secret Keys"]='(?i)aws[_-]?secret[_-]?access[_-]?key\s*[:=]\s*["\x27]?[A-Za-z0-9/+=]{40}["\x27]?'
          PATTERNS["Private Keys"]='-----BEGIN (RSA |DSA |EC |OPENSSH )?PRIVATE KEY-----'
          PATTERNS["Generic Secrets"]='(?i)(password|passwd|pwd|secret|token)\s*[:=]\s*["\x27][^\s"\x27]{8,}["\x27]'
          PATTERNS["Bearer Tokens"]='(?i)bearer\s+[a-zA-Z0-9_\-\.]+\.[a-zA-Z0-9_\-\.]+\.[a-zA-Z0-9_\-\.]+'
          PATTERNS["GitHub Tokens"]='gh[pousr]_[A-Za-z0-9_]{36,}'
          PATTERNS["Slack Tokens"]='xox[baprs]-[0-9]{10,13}-[0-9]{10,13}(-[a-zA-Z0-9]{24,})?'
          PATTERNS["Google API Keys"]='AIza[0-9A-Za-z\-_]{35}'
          PATTERNS["Stripe Keys"]='(sk|pk)_(live|test)_[0-9a-zA-Z]{24,}'

          for pattern_name in "${!PATTERNS[@]}"; do
            echo "Checking for: $pattern_name"
            # Exclude workflow files and gitleaks config (they contain detection patterns, not actual secrets)
            MATCHES=$(grep -rPn "${PATTERNS[$pattern_name]}" --include="*.{js,ts,py,java,go,rb,php,yml,yaml,json,xml,conf,cfg,ini,env,sh,bash,zsh}" . 2>/dev/null | grep -v -E '(\.github/workflows/|\.gitleaks\.toml)' || true)
            if [ -n "$MATCHES" ]; then
              echo "::error::Found potential $pattern_name:"
              echo "$MATCHES" | head -20
              FOUND_ISSUES=1
            fi
          done

          if [ "$FOUND_ISSUES" -eq 1 ]; then
            echo "::error::Sensitive patterns detected in the codebase!"
            exit 1
          fi
          echo "No hardcoded sensitive patterns found"

      - name: Scan for PII (Personal Identifiable Information)
        run: |
          echo "Scanning for PII patterns..."
          FOUND_PII=0

          # Email addresses (excluding common examples and test patterns)
          echo "Checking for email addresses..."
          EMAIL_MATCHES=$(grep -rPn '[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}' \
            --include="*.{js,ts,py,java,go,rb,php,json,xml,txt,md,csv}" . 2>/dev/null | \
            grep -v -E '(example\.com|test\.com|localhost|@types|@param|@returns|noreply|no-reply|\.example\.|email@domain)' || true)
          if [ -n "$EMAIL_MATCHES" ]; then
            echo "::warning::Found potential email addresses (review for PII):"
            echo "$EMAIL_MATCHES" | head -10
            FOUND_PII=1
          fi

          # Phone numbers (various formats)
          echo "Checking for phone numbers..."
          PHONE_MATCHES=$(grep -rPn '(?<![0-9])(\+?1?[-.\s]?\(?[0-9]{3}\)?[-.\s]?[0-9]{3}[-.\s]?[0-9]{4})(?![0-9])' \
            --include="*.{js,ts,py,java,go,rb,php,json,xml,txt,md,csv}" . 2>/dev/null | \
            grep -v -E '(example|test|mock|fake|000|555-|123-456)' || true)
          if [ -n "$PHONE_MATCHES" ]; then
            echo "::warning::Found potential phone numbers (review for PII):"
            echo "$PHONE_MATCHES" | head -10
            FOUND_PII=1
          fi

          # Social Security Numbers
          echo "Checking for SSN patterns..."
          SSN_MATCHES=$(grep -rPn '(?<![0-9])[0-9]{3}-[0-9]{2}-[0-9]{4}(?![0-9])' \
            --include="*.{js,ts,py,java,go,rb,php,json,xml,txt,md,csv}" . 2>/dev/null | \
            grep -v -E '(example|test|mock|fake|000-00-0000|123-45-6789)' || true)
          if [ -n "$SSN_MATCHES" ]; then
            echo "::error::Found potential SSN patterns:"
            echo "$SSN_MATCHES" | head -10
            FOUND_PII=1
          fi

          # Credit Card Numbers (basic Luhn-like patterns)
          echo "Checking for credit card patterns..."
          CC_MATCHES=$(grep -rPn '(?<![0-9])(4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14}|3[47][0-9]{13}|6(?:011|5[0-9]{2})[0-9]{12})(?![0-9])' \
            --include="*.{js,ts,py,java,go,rb,php,json,xml,txt,md,csv}" . 2>/dev/null | \
            grep -v -E '(example|test|mock|fake|0000)' || true)
          if [ -n "$CC_MATCHES" ]; then
            echo "::error::Found potential credit card numbers:"
            echo "$CC_MATCHES" | head -10
            FOUND_PII=1
          fi

          if [ "$FOUND_PII" -eq 1 ]; then
            echo "::error::PII patterns detected! Please review and remove personal information."
            exit 1
          fi
          echo "No PII patterns found"

  cached-artifacts-scan:
    name: Cached Files and Artifacts Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for files that shouldn't be committed
        run: |
          echo "Scanning for cached files and artifacts that shouldn't be committed..."
          FOUND_ARTIFACTS=0

          # List of patterns for files that shouldn't be committed
          FORBIDDEN_PATTERNS=(
            # Environment and config files with secrets
            ".env"
            ".env.local"
            ".env.*.local"
            "*.env"
            ".envrc"

            # IDE and editor files
            ".idea/"
            ".vscode/settings.json"
            "*.swp"
            "*.swo"
            "*~"

            # OS files
            ".DS_Store"
            "Thumbs.db"
            "desktop.ini"

            # Dependency directories (should use package managers)
            "node_modules/"
            "vendor/"
            "__pycache__/"
            "*.pyc"
            ".pytest_cache/"

            # Build artifacts
            "dist/"
            "build/"
            "*.min.js"
            "*.bundle.js"

            # Log files
            "*.log"
            "npm-debug.log*"
            "yarn-debug.log*"
            "yarn-error.log*"

            # Credential files
            "credentials.json"
            "credentials.yml"
            "secrets.json"
            "secrets.yml"
            "secrets.yaml"
            ".htpasswd"
            "*.pem"
            "*.key"
            "*.p12"
            "*.pfx"

            # Database files
            "*.sqlite"
            "*.sqlite3"
            "*.db"

            # Backup files
            "*.bak"
            "*.backup"
            "*.old"

            # Archives that might contain sensitive data
            "*.zip"
            "*.tar"
            "*.tar.gz"
            "*.rar"
          )

          for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
            # Use find for directory patterns, git ls-files for file patterns
            if [[ "$pattern" == */ ]]; then
              # Directory pattern
              dir_name="${pattern%/}"
              MATCHES=$(find . -type d -name "$dir_name" -not -path "./.git/*" 2>/dev/null || true)
            else
              # File pattern - check if tracked by git
              MATCHES=$(git ls-files "$pattern" 2>/dev/null || true)
            fi

            if [ -n "$MATCHES" ]; then
              echo "::error::Found forbidden file/directory pattern '$pattern':"
              echo "$MATCHES" | head -10
              FOUND_ARTIFACTS=1
            fi
          done

          if [ "$FOUND_ARTIFACTS" -eq 1 ]; then
            echo "::error::Found cached files or artifacts that shouldn't be committed!"
            echo "Please add these to .gitignore and remove from the repository."
            exit 1
          fi
          echo "No forbidden cached files or artifacts found"

      - name: Check for large files that might be artifacts
        run: |
          echo "Checking for suspiciously large files..."
          # Find files larger than 5MB that are tracked by git
          LARGE_FILES=$(find . -type f -size +5M -not -path "./.git/*" 2>/dev/null || true)

          if [ -n "$LARGE_FILES" ]; then
            echo "::warning::Found large files (>5MB) that might be artifacts:"
            echo "$LARGE_FILES"
            echo "Please verify these files should be in the repository."
          fi

  env-config-scan:
    name: Environment and Config Files Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Scan config files for sensitive data
        run: |
          echo "Scanning configuration files for sensitive data..."
          FOUND_SENSITIVE=0

          # Find all config-like files (excluding workflow files and gitleaks config)
          # Exclude source code files (.lua, .swift) - they're scanned by gitleaks/detect-secrets
          CONFIG_FILES=$(find . -type f \( \
            -name "*.yml" -o -name "*.yaml" -o -name "*.json" -o \
            -name "*.xml" -o -name "*.conf" -o -name "*.cfg" -o \
            -name "*.ini" -o -name "*.toml" -o -name "*.properties" -o \
            -name "config.*" -o -name "settings.*" -o -name "*.config.*" \
            \) -not -path "./.git/*" -not -path "./node_modules/*" \
            -not -path "./.github/workflows/*" -not -name ".gitleaks.toml" \
            -not -name "*.lua" -not -name "*.swift" 2>/dev/null || true)

          if [ -n "$CONFIG_FILES" ]; then
            echo "Found config files to scan:"
            echo "$CONFIG_FILES"
            echo ""

            # Scan each config file for sensitive patterns
            while IFS= read -r file; do
              if [ -f "$file" ]; then
                # Check for sensitive keys with non-placeholder values
                SENSITIVE_MATCHES=$(grep -Pn '(?i)(password|secret|api[_-]?key|access[_-]?key|private[_-]?key|token|auth|credential|connection[_-]?string)\s*[:=]\s*["\x27]?(?!(\$\{|{{|<|%|YOUR_|REPLACE_|XXX|placeholder|example|changeme|password|secret|null|true|false|none|empty|\*+|\.\.\.)["\x27]?\s*$)[^\s"\x27]+' "$file" 2>/dev/null || true)

                if [ -n "$SENSITIVE_MATCHES" ]; then
                  echo "::error::Found potential sensitive data in $file:"
                  echo "$SENSITIVE_MATCHES"
                  FOUND_SENSITIVE=1
                fi
              fi
            done <<< "$CONFIG_FILES"
          fi

          if [ "$FOUND_SENSITIVE" -eq 1 ]; then
            echo "::error::Sensitive data found in configuration files!"
            echo "Please use environment variables or secret management instead."
            exit 1
          fi
          echo "No sensitive data found in configuration files"

      - name: Verify .gitignore includes sensitive patterns
        run: |
          echo "Checking .gitignore for recommended patterns..."

          RECOMMENDED_PATTERNS=(
            ".env"
            "*.pem"
            "*.key"
            "credentials"
            "secrets"
            ".env.local"
            "*.log"
          )

          MISSING_PATTERNS=()

          if [ -f ".gitignore" ]; then
            for pattern in "${RECOMMENDED_PATTERNS[@]}"; do
              if ! grep -q "$pattern" .gitignore 2>/dev/null; then
                MISSING_PATTERNS+=("$pattern")
              fi
            done

            if [ ${#MISSING_PATTERNS[@]} -gt 0 ]; then
              echo "::warning::Consider adding these patterns to .gitignore:"
              printf '%s\n' "${MISSING_PATTERNS[@]}"
            else
              echo ".gitignore includes all recommended sensitive patterns"
            fi
          else
            echo "::warning::No .gitignore file found. Consider creating one with patterns for sensitive files."
          fi

  apple-id-scan:
    name: Apple Team/Developer ID Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Scan for Apple Team ID and Developer ID
        run: |
          echo "Scanning for Apple Team ID and Developer ID..."
          FOUND_APPLE_ID=0

          # Apple Team IDs are 10-character alphanumeric strings (e.g., ABC1234DEF)
          # They appear in various places in Xcode projects and signing configs

          # Patterns to search for
          declare -A PATTERNS
          PATTERNS["DEVELOPMENT_TEAM"]='DEVELOPMENT_TEAM\s*=\s*[A-Z0-9]{10}'
          PATTERNS["TeamIdentifier"]='<key>com\.apple\.developer\.team-identifier</key>\s*<string>[A-Z0-9]{10}</string>'
          PATTERNS["TeamID in plist"]='<key>TeamID</key>\s*<string>[A-Z0-9]{10}</string>'
          PATTERNS["CODE_SIGN_IDENTITY with ID"]='CODE_SIGN_IDENTITY.*Developer ID'
          PATTERNS["Signing Team"]='PROVISIONING_PROFILE_SPECIFIER.*=.*[A-Z0-9]{10}'
          PATTERNS["Apple ID in xcconfig"]='^[A-Z_]*TEAM[A-Z_]*\s*=\s*[A-Z0-9]{10}'

          # File types to scan
          FILE_PATTERNS="*.pbxproj *.xcconfig *.plist *.entitlements *.swift *.m *.h"

          for pattern_name in "${!PATTERNS[@]}"; do
            echo "Checking for: $pattern_name"
            MATCHES=$(grep -rPn "${PATTERNS[$pattern_name]}" \
              --include="*.pbxproj" --include="*.xcconfig" --include="*.plist" \
              --include="*.entitlements" --include="*.swift" --include="*.m" \
              --include="*.h" --include="*.json" --include="*.yml" --include="*.yaml" \
              . 2>/dev/null | grep -v -E '\.github/workflows/' || true)

            if [ -n "$MATCHES" ]; then
              echo "::error::Found potential Apple ID pattern ($pattern_name):"
              echo "$MATCHES" | head -10
              FOUND_APPLE_ID=1
            fi
          done

          # Also do a general search for 10-char Team ID patterns in signing contexts
          echo "Checking for generic Team ID patterns..."
          TEAM_ID_MATCHES=$(grep -rPn '(?i)(team|signing|developer|provision)[^=]*=\s*"?[A-Z0-9]{10}"?' \
            --include="*.pbxproj" --include="*.xcconfig" --include="*.plist" \
            --include="*.entitlements" --include="*.json" \
            . 2>/dev/null | grep -v -E '(example|placeholder|YOUR_TEAM|XXXXXXXXXX|\.github/workflows/)' || true)

          if [ -n "$TEAM_ID_MATCHES" ]; then
            echo "::error::Found potential Team ID in signing config:"
            echo "$TEAM_ID_MATCHES" | head -10
            FOUND_APPLE_ID=1
          fi

          if [ "$FOUND_APPLE_ID" -eq 1 ]; then
            echo "::error::Apple Team ID or Developer ID detected!"
            echo "Please remove personal/organization Apple IDs before open-sourcing."
            echo "Use placeholder values like 'YOUR_TEAM_ID' or remove signing config entirely."
            exit 1
          fi
          echo "No Apple Team ID or Developer ID found"

  # Summary job that depends on all scans
  scan-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs:
      - gitleaks-scan
      - trufflehog-scan
      - detect-secrets-scan
      - sensitive-data-scan
      - cached-artifacts-scan
      - env-config-scan
      - apple-id-scan
    if: always()
    steps:
      - name: Check scan results
        run: |
          echo "=== Security Scan Summary ==="
          echo ""

          # Check if any job failed
          if [ "${{ needs.gitleaks-scan.result }}" == "failure" ]; then
            echo "‚ùå Gitleaks scan: FAILED"
            FAILED=1
          else
            echo "‚úÖ Gitleaks scan: PASSED"
          fi

          if [ "${{ needs.trufflehog-scan.result }}" == "failure" ]; then
            echo "‚ùå TruffleHog scan: FAILED"
            FAILED=1
          else
            echo "‚úÖ TruffleHog scan: PASSED"
          fi

          if [ "${{ needs.detect-secrets-scan.result }}" == "failure" ]; then
            echo "‚ùå Detect-secrets scan: FAILED"
            FAILED=1
          else
            echo "‚úÖ Detect-secrets scan: PASSED"
          fi

          if [ "${{ needs.sensitive-data-scan.result }}" == "failure" ]; then
            echo "‚ùå Sensitive data scan: FAILED"
            FAILED=1
          else
            echo "‚úÖ Sensitive data scan: PASSED"
          fi

          if [ "${{ needs.cached-artifacts-scan.result }}" == "failure" ]; then
            echo "‚ùå Cached artifacts scan: FAILED"
            FAILED=1
          else
            echo "‚úÖ Cached artifacts scan: PASSED"
          fi

          if [ "${{ needs.env-config-scan.result }}" == "failure" ]; then
            echo "‚ùå Environment/config scan: FAILED"
            FAILED=1
          else
            echo "‚úÖ Environment/config scan: PASSED"
          fi

          if [ "${{ needs.apple-id-scan.result }}" == "failure" ]; then
            echo "‚ùå Apple Team/Developer ID scan: FAILED"
            FAILED=1
          else
            echo "‚úÖ Apple Team/Developer ID scan: PASSED"
          fi

          echo ""

          if [ "${FAILED:-0}" == "1" ]; then
            echo "::error::One or more security scans failed. Please review the logs above."
            exit 1
          fi

          echo "üéâ All security scans passed!"
