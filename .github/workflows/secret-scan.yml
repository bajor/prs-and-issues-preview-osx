name: Secret and Sensitive Data Scan

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  gitleaks-scan:
    name: Gitleaks Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  cached-artifacts-scan:
    name: Cached Files and Artifacts Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for files that shouldn't be committed
        run: |
          echo "Scanning for cached files and artifacts that shouldn't be committed..."
          FOUND_ARTIFACTS=0

          # List of patterns for files that shouldn't be committed
          FORBIDDEN_PATTERNS=(
            # Environment and config files with secrets
            ".env"
            ".env.local"
            ".env.*.local"
            "*.env"
            ".envrc"

            # IDE and editor files
            ".idea/"
            ".vscode/settings.json"
            "*.swp"
            "*.swo"
            "*~"

            # OS files
            ".DS_Store"
            "Thumbs.db"
            "desktop.ini"

            # Dependency directories (should use package managers)
            "node_modules/"
            "vendor/"
            "__pycache__/"
            "*.pyc"
            ".pytest_cache/"

            # Build artifacts
            "dist/"
            "build/"
            "*.min.js"
            "*.bundle.js"

            # Log files
            "*.log"
            "npm-debug.log*"
            "yarn-debug.log*"
            "yarn-error.log*"

            # Credential files
            "credentials.json"
            "credentials.yml"
            "secrets.json"
            "secrets.yml"
            "secrets.yaml"
            ".htpasswd"
            "*.pem"
            "*.key"
            "*.p12"
            "*.pfx"

            # Database files
            "*.sqlite"
            "*.sqlite3"
            "*.db"

            # Backup files
            "*.bak"
            "*.backup"
            "*.old"

            # Archives that might contain sensitive data
            "*.zip"
            "*.tar"
            "*.tar.gz"
            "*.rar"
          )

          for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
            # Use find for directory patterns, git ls-files for file patterns
            if [[ "$pattern" == */ ]]; then
              # Directory pattern
              dir_name="${pattern%/}"
              MATCHES=$(find . -type d -name "$dir_name" -not -path "./.git/*" 2>/dev/null || true)
            else
              # File pattern - check if tracked by git
              MATCHES=$(git ls-files "$pattern" 2>/dev/null || true)
            fi

            if [ -n "$MATCHES" ]; then
              echo "::error::Found forbidden file/directory pattern '$pattern':"
              echo "$MATCHES" | head -10
              FOUND_ARTIFACTS=1
            fi
          done

          if [ "$FOUND_ARTIFACTS" -eq 1 ]; then
            echo "::error::Found cached files or artifacts that shouldn't be committed!"
            echo "Please add these to .gitignore and remove from the repository."
            exit 1
          fi
          echo "No forbidden cached files or artifacts found"

      - name: Check for large files that might be artifacts
        run: |
          echo "Checking for suspiciously large files..."
          # Find files larger than 5MB that are tracked by git
          LARGE_FILES=$(find . -type f -size +5M -not -path "./.git/*" 2>/dev/null || true)

          if [ -n "$LARGE_FILES" ]; then
            echo "::warning::Found large files (>5MB) that might be artifacts:"
            echo "$LARGE_FILES"
            echo "Please verify these files should be in the repository."
          fi

  apple-id-scan:
    name: Apple Team/Developer ID Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Scan for Apple Team ID and Developer ID
        run: |
          echo "Scanning for Apple Team ID and Developer ID..."
          FOUND_APPLE_ID=0

          # Apple Team IDs are 10-character alphanumeric strings (e.g., ABC1234DEF)
          # They appear in various places in Xcode projects and signing configs

          # Patterns to search for
          declare -A PATTERNS
          PATTERNS["DEVELOPMENT_TEAM"]='DEVELOPMENT_TEAM\s*=\s*[A-Z0-9]{10}'
          PATTERNS["TeamIdentifier"]='<key>com\.apple\.developer\.team-identifier</key>\s*<string>[A-Z0-9]{10}</string>'
          PATTERNS["TeamID in plist"]='<key>TeamID</key>\s*<string>[A-Z0-9]{10}</string>'
          PATTERNS["CODE_SIGN_IDENTITY with ID"]='CODE_SIGN_IDENTITY.*Developer ID'
          PATTERNS["Signing Team"]='PROVISIONING_PROFILE_SPECIFIER.*=.*[A-Z0-9]{10}'
          PATTERNS["Apple ID in xcconfig"]='^[A-Z_]*TEAM[A-Z_]*\s*=\s*[A-Z0-9]{10}'

          # File types to scan
          FILE_PATTERNS="*.pbxproj *.xcconfig *.plist *.entitlements *.swift *.m *.h"

          for pattern_name in "${!PATTERNS[@]}"; do
            echo "Checking for: $pattern_name"
            MATCHES=$(grep -rPn "${PATTERNS[$pattern_name]}" \
              --include="*.pbxproj" --include="*.xcconfig" --include="*.plist" \
              --include="*.entitlements" --include="*.swift" --include="*.m" \
              --include="*.h" --include="*.json" --include="*.yml" --include="*.yaml" \
              . 2>/dev/null | grep -v -E '\.github/workflows/' || true)

            if [ -n "$MATCHES" ]; then
              echo "::error::Found potential Apple ID pattern ($pattern_name):"
              echo "$MATCHES" | head -10
              FOUND_APPLE_ID=1
            fi
          done

          # Also do a general search for 10-char Team ID patterns in signing contexts
          echo "Checking for generic Team ID patterns..."
          TEAM_ID_MATCHES=$(grep -rPn '(?i)(team|signing|developer|provision)[^=]*=\s*"?[A-Z0-9]{10}"?' \
            --include="*.pbxproj" --include="*.xcconfig" --include="*.plist" \
            --include="*.entitlements" --include="*.json" \
            . 2>/dev/null | grep -v -E '(example|placeholder|YOUR_TEAM|XXXXXXXXXX|\.github/workflows/)' || true)

          if [ -n "$TEAM_ID_MATCHES" ]; then
            echo "::error::Found potential Team ID in signing config:"
            echo "$TEAM_ID_MATCHES" | head -10
            FOUND_APPLE_ID=1
          fi

          if [ "$FOUND_APPLE_ID" -eq 1 ]; then
            echo "::error::Apple Team ID or Developer ID detected!"
            echo "Please remove personal/organization Apple IDs before open-sourcing."
            echo "Use placeholder values like 'YOUR_TEAM_ID' or remove signing config entirely."
            exit 1
          fi
          echo "No Apple Team ID or Developer ID found"

  # Summary job that depends on all scans
  scan-summary:
    name: Security Scan Summary
    runs-on: ubuntu-latest
    needs:
      - gitleaks-scan
      - cached-artifacts-scan
      - apple-id-scan
    if: always()
    steps:
      - name: Check scan results
        run: |
          echo "=== Security Scan Summary ==="
          echo ""

          FAILED=0

          if [ "${{ needs.gitleaks-scan.result }}" == "failure" ]; then
            echo "‚ùå Gitleaks scan: FAILED"
            FAILED=1
          else
            echo "‚úÖ Gitleaks scan: PASSED"
          fi

          if [ "${{ needs.cached-artifacts-scan.result }}" == "failure" ]; then
            echo "‚ùå Cached artifacts scan: FAILED"
            FAILED=1
          else
            echo "‚úÖ Cached artifacts scan: PASSED"
          fi

          if [ "${{ needs.apple-id-scan.result }}" == "failure" ]; then
            echo "‚ùå Apple Team/Developer ID scan: FAILED"
            FAILED=1
          else
            echo "‚úÖ Apple Team/Developer ID scan: PASSED"
          fi

          echo ""

          if [ "$FAILED" == "1" ]; then
            echo "::error::One or more security scans failed. Please review the logs above."
            exit 1
          fi

          echo "üéâ All security scans passed!"
